services:
  admin-api:
    build: .
    container_name: ivd-admin-api
    command: ["python3", "-m", "app.admin_server"]
    env_file:
      - .docker.env
    environment:
      ADMIN_API_HOST: "0.0.0.0"
      ADMIN_API_PORT: "8789"
    ports:
      - "8090:8789"
    volumes:
      # Dev-friendly: mount source so UI/code changes take effect without rebuilding images.
      - ./app:/app/app
      - ./rules:/app/rules
      - ./data:/app/data
      - ./artifacts:/app/artifacts
      - ./logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8789/healthz >/dev/null || exit 1"]
      interval: 15s
      timeout: 3s
      retries: 10

  scheduler-worker:
    build: .
    container_name: ivd-scheduler-worker
    command: ["python3", "-m", "app.workers.scheduler_worker"]
    env_file:
      - .docker.env
    environment:
      SCHEDULER_PROFILE: "enhanced"
      SCHEDULER_REFRESH_SECONDS: "60"
    volumes:
      # Dev-friendly: mount source so scheduler changes take effect without rebuilding images.
      - ./app:/app/app
      - ./rules:/app/rules
      - ./data:/app/data
      - ./artifacts:/app/artifacts
      - ./logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python3 -c \"import json,time,pathlib; p=pathlib.Path('/app/logs/scheduler_worker_heartbeat.json'); j=json.loads(p.read_text()); assert time.time()-float(j.get('ts',0))<120\""
        ]
      interval: 30s
      timeout: 3s
      retries: 10
