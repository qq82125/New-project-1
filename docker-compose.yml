services:
  db:
    image: postgres:15-alpine
    container_name: ivd-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-ivd}
      POSTGRES_USER: ${POSTGRES_USER:-ivd}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ivd_dev_only_change_me}
    ports:
      - "5433:5432"
    volumes:
      - ivd_pgdata:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-ivd} -d ${POSTGRES_DB:-ivd} -h 127.0.0.1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 12

  admin-api:
    build: .
    container_name: ivd-admin-api
    command: ["python3", "-m", "app.admin_server"]
    env_file:
      - .docker.env
      - .mail.env
    environment:
      ADMIN_API_HOST: "0.0.0.0"
      ADMIN_API_PORT: "8789"
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg://ivd:ivd_dev_only_change_me@db:5432/ivd}
      DATABASE_URL_SECONDARY: ${DATABASE_URL_SECONDARY:-}
      DB_WRITE_MODE: ${DB_WRITE_MODE:-single}
      DB_READ_MODE: ${DB_READ_MODE:-primary}
      DB_DUAL_STRICT: ${DB_DUAL_STRICT:-false}
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "8090:8789"
    volumes:
      # Run code from image to avoid macOS bind-mount import deadlock.
      - ./rules:/app/rules
      - ./data:/app/data
      - ./artifacts:/app/artifacts
      - ./logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8789/healthz >/dev/null || exit 1"]
      interval: 15s
      timeout: 3s
      retries: 10

  scheduler-worker:
    build: .
    container_name: ivd-scheduler-worker
    command: ["python3", "-m", "app.workers.scheduler_worker"]
    env_file:
      - .docker.env
      - .mail.env
    environment:
      SCHEDULER_PROFILE: "enhanced"
      SCHEDULER_REFRESH_SECONDS: "60"
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg://ivd:ivd_dev_only_change_me@db:5432/ivd}
      DATABASE_URL_SECONDARY: ${DATABASE_URL_SECONDARY:-}
      DB_WRITE_MODE: ${DB_WRITE_MODE:-single}
      DB_READ_MODE: ${DB_READ_MODE:-primary}
      DB_DUAL_STRICT: ${DB_DUAL_STRICT:-false}
    depends_on:
      db:
        condition: service_healthy
    volumes:
      # Run code from image to avoid macOS bind-mount import deadlock.
      - ./rules:/app/rules
      - ./data:/app/data
      - ./artifacts:/app/artifacts
      - ./logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python3 -c \"import json,time,pathlib; p=pathlib.Path('/app/logs/scheduler_worker_heartbeat.json'); j=json.loads(p.read_text()); assert time.time()-float(j.get('ts',0))<120\""
        ]
      interval: 30s
      timeout: 3s
      retries: 10

  web:
    build: ./web
    container_name: ivd-web
    environment:
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-/api}
      ADMIN_API_INTERNAL_BASE: ${ADMIN_API_INTERNAL_BASE:-http://admin-api:8789}
    depends_on:
      admin-api:
        condition: service_started
    ports:
      - "${WEB_PORT:-3001}:3000"
    restart: unless-stopped

volumes:
  ivd_pgdata:
