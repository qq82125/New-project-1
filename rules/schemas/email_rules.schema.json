{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.local/schemas/email_rules.schema.json",
  "title": "Email Rules Schema",
  "type": "object",
  "required": [
    "ruleset",
    "version",
    "profile",
    "feature_flags",
    "compatibility",
    "delivery",
    "retry",
    "fallback",
    "logging"
  ],
  "properties": {
    "ruleset": {
      "type": "string",
      "const": "email_rules"
    },
    "version": {
      "type": "string",
      "minLength": 1
    },
    "profile": {
      "type": "string",
      "minLength": 1
    },
    "description": {
      "type": "string"
    },
    "feature_flags": {
      "type": "object",
      "required": [
        "enable_new_email_rules"
      ],
      "properties": {
        "enable_new_email_rules": { "type": "boolean" },
        "enable_explain": { "type": "boolean" },
        "require_sent_mail_guard": { "type": "boolean" }
      },
      "additionalProperties": true
    },
    "compatibility": {
      "type": "object",
      "required": [
        "backward_compatible",
        "fallback_to_legacy_on_error"
      ],
      "properties": {
        "backward_compatible": { "type": "boolean" },
        "fallback_to_legacy_on_error": { "type": "boolean" }
      },
      "additionalProperties": true
    },
    "delivery": {
      "type": "object",
      "required": [
        "transport",
        "date_tz",
        "subject_template",
        "from_env",
        "to_env"
      ],
      "properties": {
        "transport": {
          "type": "string",
          "enum": ["icloud_smtp", "smtp"]
        },
        "date_tz": { "type": "string", "minLength": 1 },
        "subject_template": { "type": "string", "minLength": 1 },
        "from_name": { "type": "string" },
        "from_env": { "type": "string", "minLength": 1 },
        "to_env": { "type": "string", "minLength": 1 },
        "dedupe_key_template": { "type": "string" }
      },
      "additionalProperties": true
    },
    "retry": {
      "type": "object",
      "required": [
        "connect_timeout_sec",
        "max_time_sec",
        "max_retries",
        "backoff_initial_sec",
        "backoff_max_sec"
      ],
      "properties": {
        "connect_timeout_sec": { "type": "integer", "minimum": 1 },
        "max_time_sec": { "type": "integer", "minimum": 1 },
        "max_retries": { "type": "integer", "minimum": 1 },
        "backoff_initial_sec": { "type": "integer", "minimum": 1 },
        "backoff_max_sec": { "type": "integer", "minimum": 1 }
      },
      "additionalProperties": true
    },
    "fallback": {
      "type": "object",
      "required": [
        "cloud_backup_enabled",
        "cloud_backup_check_sent_mail"
      ],
      "properties": {
        "cloud_backup_enabled": { "type": "boolean" },
        "cloud_backup_check_sent_mail": { "type": "boolean" },
        "cloud_backup_mailbox_env": { "type": "string" },
        "allow_resend_in_replay": { "type": "boolean" }
      },
      "additionalProperties": true
    },
    "logging": {
      "type": "object",
      "required": ["required_fields"],
      "properties": {
        "required_fields": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string" }
        }
      },
      "additionalProperties": true
    }
  },
  "additionalProperties": true
}
