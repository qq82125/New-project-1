{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.local/schemas/content_rules.schema.json",
  "title": "Content Rules Schema",
  "type": "object",
  "required": ["ruleset", "version", "profile", "defaults", "overrides", "rules", "output"],
  "properties": {
    "ruleset": { "type": "string", "const": "content_rules" },
    "version": { "type": "string", "minLength": 3 },
    "profile": { "type": "string", "enum": ["legacy", "enhanced", "default.v1", "strict.v2"] },
    "defaults": {
      "type": "object",
      "required": ["timezone", "time_window", "item_limit", "sources", "coverage_tracks", "region_filter"],
      "properties": {
        "timezone": { "type": "string", "minLength": 3 },
        "content_sources": {
          "type": "object",
          "properties": {
            "min_trust_tier": { "type": "string", "enum": ["A", "B", "C"] },
            "include_tags": {
              "type": "array",
              "items": { "type": "string", "minLength": 1 }
            },
            "exclude_tags": {
              "type": "array",
              "items": { "type": "string", "minLength": 1 }
            },
            "include_source_ids": {
              "type": "array",
              "items": { "type": "string", "minLength": 1 }
            },
            "exclude_source_ids": {
              "type": "array",
              "items": { "type": "string", "minLength": 1 }
            },
            "default_enabled_only": { "type": "boolean" }
          },
          "additionalProperties": true
        },
        "source_policy": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "min_trust_tier": {
              "oneOf": [
                { "type": "string", "enum": ["A", "B", "C"] },
                {
                  "type": "object",
                  "properties": {
                    "legacy": { "type": "string", "enum": ["A", "B", "C"], "default": "C" },
                    "enhanced": { "type": "string", "enum": ["A", "B", "C"], "default": "B" }
                  },
                  "additionalProperties": false
                }
              ],
              "default": { "legacy": "C", "enhanced": "B" }
            },
            "exclude_domains": {
              "type": "array",
              "items": { "type": "string", "minLength": 1 },
              "default": []
            },
            "exclude_source_ids": {
              "type": "array",
              "items": { "type": "string", "minLength": 1 },
              "default": []
            },
            "drop_if_url_matches": {
              "type": "array",
              "items": { "type": "string", "minLength": 1 },
              "default": []
            }
          },
          "additionalProperties": true
        },
        "source_guard": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "enforce_article_only": { "type": "boolean", "default": true },
            "article_min_paragraphs": { "type": "integer", "minimum": 1, "maximum": 20, "default": 2 },
            "article_min_text_chars": { "type": "integer", "minimum": 50, "maximum": 5000, "default": 200 },
            "allow_body_fetch_for_rss": { "type": "boolean", "default": false }
          },
          "additionalProperties": true
        },
        "time_window": {
          "type": "object",
          "required": ["primary_hours", "fallback_days"],
          "properties": {
            "primary_hours": { "type": "integer", "minimum": 1, "maximum": 72 },
            "fallback_days": { "type": "integer", "minimum": 1, "maximum": 14 }
          },
          "additionalProperties": true
        },
        "item_limit": {
          "type": "object",
          "required": ["min", "max", "topup_if_24h_lt"],
          "properties": {
            "min": { "type": "integer", "minimum": 1, "maximum": 30 },
            "max": { "type": "integer", "minimum": 1, "maximum": 50 },
            "topup_if_24h_lt": { "type": "integer", "minimum": 0, "maximum": 30 }
          },
          "additionalProperties": true
        },
        "sources": {
          "type": "object",
          "required": ["media_global", "regulatory_cn", "regulatory_apac"],
          "properties": {
            "media_global": { "$ref": "#/$defs/sourceList" },
            "regulatory_cn": { "$ref": "#/$defs/sourceList" },
            "regulatory_apac": { "$ref": "#/$defs/sourceList" }
          },
          "additionalProperties": true
        },
        "source_priority": {
          "type": "object",
          "propertyNames": { "type": "string", "minLength": 1 },
          "additionalProperties": { "type": "integer", "minimum": 0, "maximum": 1000 }
        },
        "relevance_thresholds": {
          "type": "object",
          "properties": {
            "core_min_level_for_A": { "type": "integer", "minimum": 0, "maximum": 4, "default": 3 },
            "frontier_min_level_for_F": { "type": "integer", "minimum": 0, "maximum": 4, "default": 2 }
          },
          "additionalProperties": true
        },
        "frontier_quota": {
          "type": "object",
          "properties": {
            "max_items_per_day": { "type": "integer", "minimum": 0, "maximum": 50, "default": 5 }
          },
          "additionalProperties": true
        },
        "output_tracks": {
          "type": "object",
          "properties": {
            "enable_track_split": { "type": "boolean", "default": false }
          },
          "additionalProperties": true
        },
        "relevance_keywords": {
          "type": "object",
          "properties": {
            "anchors_strong": {
              "type": "array",
              "items": { "type": "string", "minLength": 1 }
            },
            "anchors_weak": {
              "type": "array",
              "items": { "type": "string", "minLength": 1 }
            },
            "negatives": {
              "type": "array",
              "items": { "type": "string", "minLength": 1 }
            }
          },
          "additionalProperties": true
        },
        "analysis_cache": {
          "type": "object",
          "properties": {
            "enable_analysis_cache": { "type": "boolean", "default": true },
            "always_generate": { "type": "boolean", "default": false },
            "prompt_version": { "type": "string", "minLength": 1, "default": "v2" },
            "model": { "type": "string", "minLength": 1, "default": "local-heuristic-v1" },
            "model_primary": { "type": "string", "minLength": 1, "default": "local-heuristic-v1" },
            "model_fallback": { "type": "string", "minLength": 1, "default": "local-lite-v1" },
            "model_policy": { "type": "string", "enum": ["tiered", "always_primary", "always_fallback"], "default": "tiered" },
            "core_model": { "type": "string", "minLength": 1, "default": "primary" },
            "frontier_model": { "type": "string", "minLength": 1, "default": "fallback" },
            "temperature": { "type": "number", "minimum": 0.0, "maximum": 1.0, "default": 0.2 },
            "timeout_seconds": { "type": "integer", "minimum": 1, "maximum": 300, "default": 20 },
            "retries": { "type": "integer", "minimum": 0, "maximum": 5, "default": 1 },
            "backoff_seconds": { "type": "number", "minimum": 0.0, "maximum": 10.0, "default": 0.5 },
            "asset_dir": { "type": "string", "minLength": 1, "default": "artifacts/analysis" }
          },
          "additionalProperties": true
        },
        "coverage_enforcement": {
          "type": "object",
          "properties": {
            "a_core_min_items": { "type": "integer", "minimum": 0, "maximum": 50, "default": 8 },
            "f_frontier_quota": { "type": "integer", "minimum": 0, "maximum": 50, "default": 3 },
            "require_gap_explain": { "type": "boolean", "default": true }
          },
          "additionalProperties": true
        },
        "anchors_pack": {
          "type": "object",
          "properties": {
            "core": {
              "type": "array",
              "items": { "type": "string", "minLength": 1 }
            },
            "frontier": {
              "type": "array",
              "items": { "type": "string", "minLength": 1 }
            }
          },
          "additionalProperties": true
        },
        "negatives_pack": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        },
        "frontier_policy": {
          "type": "object",
          "properties": {
            "require_diagnostic_anchor": { "type": "boolean", "default": true },
            "drop_bio_general_without_diagnostic": { "type": "boolean", "default": true }
          },
          "additionalProperties": true
        },
        "evidence_policy": {
          "type": "object",
          "properties": {
            "require_evidence_for_core": { "type": "boolean", "default": true },
            "min_snippet_chars": { "type": "integer", "minimum": 1, "maximum": 500, "default": 80 },
            "degrade_if_missing": { "type": "boolean", "default": true }
          },
          "additionalProperties": true
        },
        "opportunity_index": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "window_days": { "type": "integer", "minimum": 1, "maximum": 30, "default": 7 },
            "dedupe": {
              "type": "object",
              "properties": {
                "enabled": { "type": "boolean", "default": true },
                "tail_lines_scan": { "type": "integer", "minimum": 1, "maximum": 20000, "default": 2000 }
              },
              "additionalProperties": true
            },
            "display": {
              "type": "object",
              "properties": {
                "top_n": { "type": "integer", "minimum": 1, "maximum": 20, "default": 5 },
                "suppress_unknown_both": { "type": "boolean", "default": true },
                "unknown_min_score": { "type": "integer", "minimum": 0, "maximum": 1000, "default": 5 },
                "mark_low_conf": { "type": "boolean", "default": true }
              },
              "additionalProperties": true
            }
          },
          "additionalProperties": true
        },
        "platform_url_hints": {
          "type": "object",
          "propertyNames": { "type": "string", "minLength": 1 },
          "additionalProperties": {
            "type": "array",
            "minItems": 0,
            "maxItems": 50,
            "items": { "type": "string", "minLength": 1, "maxLength": 64 }
          }
        },
        "dedupe_cluster": {
          "type": "object",
          "required": [
            "enabled",
            "window_hours",
            "key_strategies",
            "primary_select",
            "max_other_sources"
          ],
          "properties": {
            "enabled": { "type": "boolean" },
            "window_hours": { "type": "integer", "minimum": 1, "maximum": 720 },
            "key_strategies": {
              "type": "array",
              "minItems": 1,
              "items": {
                "type": "string",
                "enum": [
                  "canonical_url",
                  "normalized_url_host_path",
                  "title_fingerprint_v1"
                ]
              }
            },
            "primary_select": {
              "type": "array",
              "minItems": 1,
              "items": {
                "type": "string",
                "enum": [
                  "source_priority",
                  "evidence_grade",
                  "published_at_earliest",
                  "published_at_latest",
                  "first_seen_earliest"
                ]
              }
            },
            "max_other_sources": { "type": "integer", "minimum": 0, "maximum": 20 }
          },
          "additionalProperties": true
        },
        "coverage_tracks": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "minLength": 2 }
        },
        "region_filter": {
          "type": "object",
          "required": ["apac_min_share"],
          "properties": {
            "apac_min_share": { "type": "number", "minimum": 0.0, "maximum": 1.0 },
            "china_min_share": { "type": "number", "minimum": 0.0, "maximum": 1.0 },
            "eu_na_min_share": { "type": "number", "minimum": 0.0, "maximum": 1.0 },
            "allowed_regions": {
              "type": "array",
              "items": { "type": "string", "enum": ["北美", "欧洲", "亚太", "中国", "全球"] }
            }
          },
          "additionalProperties": true
        }
      },
      "additionalProperties": true
    },
    "overrides": {
      "type": "object",
      "required": ["enabled"],
      "properties": {
        "enabled": { "type": "boolean" },
        "keywords_pack": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "ivd_core",
              "diagnostic_tech_products",
              "regulatory_procurement",
              "oncology",
              "infection",
              "repro_genetics",
              "policy_market",
              "papers_clinical"
            ]
          }
        },
        "exclude_terms": {
          "type": "array",
          "items": { "type": "string", "minLength": 2 }
        },
        "min_confidence": { "type": "number", "minimum": 0.0, "maximum": 1.0 }
      },
      "additionalProperties": true
    },
    "rules": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["id", "enabled", "priority", "type", "params"],
        "properties": {
          "id": { "type": "string", "minLength": 3 },
          "enabled": { "type": "boolean" },
          "priority": { "type": "integer", "minimum": 0, "maximum": 100 },
          "type": {
            "type": "string",
            "enum": [
              "source_priority",
              "include_filter",
              "exclude_filter",
              "lane_mapping",
              "platform_mapping",
              "event_mapping",
              "dedupe",
              "confidence_ranking",
              "region_filter",
              "relevance_thresholds",
              "frontier_quota",
              "output_tracks",
              "relevance_keywords",
              "analysis_cache",
              "anchors_pack",
              "negatives_pack",
              "frontier_policy",
              "evidence_policy",
              "opportunity_index",
              "track_routing",
              "source_policy",
              "source_guard"
            ]
          },
          "description": { "type": "string", "minLength": 0 },
          "params": { "type": "object" }
        },
        "additionalProperties": true
      }
    },
    "output": {
      "type": "object",
      "required": ["format", "sections", "quality_audit_at_end"],
      "properties": {
        "format": { "type": "string", "enum": ["plain_text", "markdown", "html"] },
        "sections": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "enum": ["A", "B", "C", "D", "E", "F", "G"] }
        },
        "quality_audit_at_end": { "type": "boolean" },
        "per_item_summary_sentences": { "type": "integer", "minimum": 1, "maximum": 5 },
        "max_items": { "type": "integer", "minimum": 1, "maximum": 30 }
      },
      "additionalProperties": true
    }
  },
  "$defs": {
    "sourceItem": {
      "type": "object",
      "required": ["name", "url", "region", "trust_tier"],
      "properties": {
        "name": { "type": "string", "minLength": 2 },
        "url": { "type": "string", "minLength": 8 },
        "region": { "type": "string", "enum": ["北美", "欧洲", "亚太", "中国", "全球"] },
        "trust_tier": { "type": "string", "enum": ["A", "B", "C"] }
      },
      "additionalProperties": true
    },
    "sourceList": {
      "type": "array",
      "items": { "$ref": "#/$defs/sourceItem" }
    }
  },
  "additionalProperties": true
}
